name: Tests

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Make a new Laravel project
        run: |
          composer global require laravel/installer
          ~/.composer/vendor/bin/laravel new sweetalert2-laravel-test --pest --no-interaction

      - name: Install sweetalert2/laravel package and Livewire
        run: |
          cd sweetalert2-laravel-test
          composer require sweetalert2/laravel
          composer require livewire/livewire

      - name: Copy local tests to the project and run them
        run: |
          cd sweetalert2-laravel-test
          cp ../tests/*Test.php tests/Feature
          rm tests/Feature/ExampleTest.php tests/Unit/ExampleTest.php
          cp -r ../tests/Livewire app
          rm -rf resources/views
          cp -r ../tests/views resources

      - name: Set up browser testing
        run: |
          cd sweetalert2-laravel-test
          composer require pestphp/pest-plugin-browser --dev
          npm install playwright
          npx playwright install-deps
          npx playwright install

      - name: Run tests
        run: |
          cd sweetalert2-laravel-test
          ./vendor/bin/pest

      - name: Store screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: Tests/Browser/Screenshots
